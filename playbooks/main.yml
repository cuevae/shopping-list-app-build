--- # Install Node.js, GIT, NFS and Shopping-List-App
- hosts: all
  tasks:
    - name: Update cache
      apt:
        update_cache: yes
    - name: Read installation instructions for NodeJS 14
      shell: curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
    - name: Install NodeJS (NPM installs as well)
      apt:
        name: nodejs
        state: latest
    - name: Install GIT
      apt:
        name: git
        state: latest
    - name: Install PostgreSQL
      apt:
        name: postgresql
        state: latest
    - name: Clone app repository
      git:
        repo: https://github.com/cuevae/shopping-list-rn-expo.git
        dest: /vagrant/shopping-list-app
    - name: Check if node_modules symlink exists
      stat:
        path: /vagrant/shopping-list-app/node_modules
      register: node_modules_symlink
    - name: Delete node_modules symlink if exists
      file:
        path: /vagrant/shopping-list-app/node_modules
        state: absent
      when: node_modules_symlink.stat.exists
    - name: Check if node_modules folder exists
      stat:
        path: /home/vagrant/node_modules
      register: node_modules_folder
    - name: Delete node_modules folder if exists
      file:
        path: /home/vagrant/node_modules
        state: absent
      when: node_modules_folder.stat.exists
    - name: Create node_modules folder
      file:
        path: /home/vagrant/node_modules
        owner: vagrant
        group: vagrant
        mode: '0755'
        state: directory
    - name: Symlink node_modules folder
      file: 
        src: /home/vagrant/node_modules
        dest: /vagrant/shopping-list-app/node_modules
        owner: vagrant
        group: vagrant
        state: link
    - name: Install NPM dependencies based on package.json from the repository above
      npm:
        path: /vagrant/shopping-list-app